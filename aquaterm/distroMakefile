ifndef $(BUILD_DIR)
BUILD_DIR=$(OBJROOT)
endif

PACKAGE=AquaTerm
VERSION=1.0.0
RELEASENAME=AquaTerm1.0.b3
## RELEASENAME=$(PACKAGE)$(VERSION)

## Stage the release files
## -----------------------
PKG_ROOT=$(BUILD_DIR)/pkg_root
DMG_ROOT=$(BUILD_DIR)/dmg_root
EXTRAS_DEST="$(DMG_ROOT)/Developer Extras"
ADAPT_DEST=$(EXTRAS_DEST)/adapters
## Get the source directories
## --------------------------
APPSRCDIR=$(SRCROOT)
HELPDIR=$(SRCROOT)/Help
ADAPTSRCDIR=$(SRCROOT)/../adapters

all:pre dmg post

pkg: app lib fwk headers
	freeze -v $(APPSRCDIR)/installer/installer.packproj

dmg: adapters info doc pkg
	hdiutil create -volname AquaTerm -fs HFS+ -srcfolder $(DMG_ROOT) $(BUILD_DIR)/$(RELEASENAME).dmg
	
pre: clean
	mkdir -p $(PKG_ROOT)
	mkdir -p $(DMG_ROOT)

post:
	ls -Rp $(DMG_ROOT) 

app:
	xcodebuild -target AQTFwk clean -buildstyle Deployment
##	xcodebuild -target libaqt -buildstyle Deployment
	xcodebuild -target AquaTerm clean -buildstyle Deployment
## FIXME: Reverse this so no CPP options => .app is built	
	xcodebuild -target AquaTerm -buildstyle Deployment GCC_PREPROCESSOR_DEFINITIONS="AQT_APP"
	cp -RPf $(BUILD_DIR)/AquaTerm.app $(PKG_ROOT)/.

fwk:
	## mkdir -p $(PKG_ROOT)/framework
	cp -RPf $(BUILD_DIR)/AquaTerm.framework $(PKG_ROOT)/.
	
lib:
	@echo "lib is just links to framework..."
##	mkdir -p $(PKG_ROOT)/lib
##	cp $(BUILD_DIR)/libaquaterm.$(VERSION).dylib $(PKG_ROOT)/lib/.

headers:
	@echo "headers are just links to framework..."
##	mkdir -p $(PKG_ROOT)/include
##	cp $(APPSRCDIR)/{AQTAdapter,aquaterm}.h $(PKG_ROOT)/include/.

adapters:c fortran gnuplot pgplot plplot

info:
	cp $(APPSRCDIR)/{ReadMe.rtf,ReleaseNotes} $(DMG_ROOT)/.

doc:
	cp $(HELPDIR)/AQTAdapter.html $(EXTRAS_DEST)/.

help:
	@echo "Skipping help..."
#	-rm -rf $(BUILD_DIR)/help
#	mkdir -p $(BUILD_DIR)/help
#	./makeHelp c fortran gnuplot pgplot plplot
#	cp $(APPSRCDIR)/*.css $(BUILD_DIR)/help/.
#	open $(BUILD_DIR)/help/help.html 
#	cp -R $(BUILD_DIR)/help $(DEST)/.
	
clean:
	-rm -rf $(PKG_ROOT)
	-rm -rf $(DMG_ROOT)
	-rm -rf $(BUILD_DIR)/$(RELEASENAME).dmg

## -------------------------
## - adapters
## -------------------------
c:
	mkdir -p $(ADAPT_DEST)/c
	cp $(ADAPTSRCDIR)/c/{demo.c,eventdemo1.c,eventdemo2.c,Makefile,ReadMe,ReleaseNotes} $(ADAPT_DEST)/c/.

fortran:
	mkdir -p $(ADAPT_DEST)/fortran
	cp $(ADAPTSRCDIR)/fortran/{demo.f,eventdemo1.f,f2aqt.{h,m},f2aquaterm.m,Makefile,ReadMe,ReleaseNotes} $(ADAPT_DEST)/fortran/.

gnuplot:
	mkdir -p $(ADAPT_DEST)/gnuplot
	cp $(ADAPTSRCDIR)/gnuplot/{ReadMe,ReleaseNotes} $(ADAPT_DEST)/gnuplot/.

pgplot:
	mkdir -p $(ADAPT_DEST)/pgplot
	cp $(ADAPTSRCDIR)/pgplot/{aqdriv.m,g77_gcc_AQT.conf,xlf_gcc_AQT.conf,ReadMe,ReleaseNotes} $(ADAPT_DEST)/pgplot/.

plplot:
	mkdir -p $(ADAPT_DEST)/plplot
	cp $(ADAPTSRCDIR)/plplot/{aqtplplot.{h,m},ReadMe,ReleaseNotes} $(ADAPT_DEST)/plplot/.